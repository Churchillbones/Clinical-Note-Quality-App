{% extends "base.html" %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Tab Navigation -->
    {% if result.chain_of_thought and result.chain_of_thought|length > 0 %}
    <div class="mb-4">
        <nav class="flex space-x-1 bg-gray-100 p-1 rounded-lg">
            <button id="results-tab" class="tab-button active flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors duration-200 bg-white text-blue-600 shadow-sm" data-target="results-content">
                📊 Analysis Results
            </button>
            <button id="reasoning-tab" class="tab-button flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors duration-200 text-gray-600 hover:text-gray-900" data-target="reasoning-content">
                🧠 AI Reasoning Analysis Log
            </button>
        </nav>
    </div>
    {% endif %}

    <!-- Results Content Tab -->
    <div id="results-content" class="tab-content">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Assessment Results</h2>
                <a href="/" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    Grade Another Note
                </a>
            </div>
            
            <!-- Executive Summary Dashboard -->
            <div class="mb-6">
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-6">
                    <div class="text-center">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">PDQI-9 Clinical Documentation Score</h3>
                        <div class="text-4xl font-bold text-blue-600 mb-2">
                            {{ "%.0f"|format(result.pdqi_total) }}/45
                        </div>
                        <div class="text-2xl font-semibold 
                            {% if result.overall_grade == 'A' %}text-green-600
                            {% elif result.overall_grade == 'B' %}text-blue-600
                            {% elif result.overall_grade == 'C' %}text-yellow-600
                            {% elif result.overall_grade == 'D' %}text-orange-600
                            {% else %}text-red-600{% endif %}">
                            Grade: {{ result.overall_grade }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Narrative Summary - Progressive Disclosure -->
            <div class="mb-6">
                <div class="narrative-card bg-white border border-gray-200 rounded-lg shadow-sm">
                    <div class="card-header p-4 cursor-pointer" data-target="ai-summary">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center space-x-3">
                                <h3 class="text-xl font-semibold text-blue-700">🤖 AI Analysis Summary</h3>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="summary-preview text-sm text-gray-600">
                                    Click to view comprehensive AI narrative explanations
                                </div>
                                <svg class="expand-icon w-5 h-5 text-gray-400 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div id="ai-summary" class="card-content hidden border-t border-gray-100">
                        <div class="p-4 space-y-4">
                            {% if result.pdqi_scores.summary %}
                            <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-lg">
                                <p class="mb-2 font-medium text-blue-800">PDQI-9 Analysis:</p>
                                <p class="italic text-blue-700">{{ result.pdqi_scores.summary }}</p>
                            </div>
                            {% endif %}
                            
                            {% if result.pdqi_scores.scoring_rationale %}
                            <div class="bg-indigo-50 border-l-4 border-indigo-400 p-4 rounded-lg">
                                <p class="mb-2 font-medium text-indigo-800">Scoring Methodology:</p>
                                <p class="text-sm text-indigo-700">{{ result.pdqi_scores.scoring_rationale }}</p>
                            </div>
                            {% endif %}
                            
                            {% if result.factuality_analysis.summary %}
                            <div class="bg-purple-50 border-l-4 border-purple-400 p-4 rounded-lg">
                                <p class="mb-2 font-medium text-purple-800">Factuality Assessment:</p>
                                <p class="italic text-purple-700">{{ result.factuality_analysis.summary }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- PDQI-9 Analysis - Progressive Disclosure -->
            <div class="mb-6">
                <div class="narrative-card bg-white border border-gray-200 rounded-lg shadow-sm">
                    <div class="card-header p-4 cursor-pointer" data-target="pdqi-analysis">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center space-x-4">
                                <h3 class="text-xl font-semibold">📋 PDQI-9 Clinical Documentation</h3>
                                <span class="text-lg font-bold bg-blue-100 text-blue-800 px-3 py-1 rounded-full">
                                    Total: {{ "%.0f"|format(result.pdqi_total) }}/45
                                </span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="summary-preview text-sm text-gray-600">
                                    9 dimensions • Click to view detailed analysis
                                </div>
                                <svg class="expand-icon w-5 h-5 text-gray-400 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div id="pdqi-analysis" class="card-content hidden border-t border-gray-100">
                        <div class="p-4">
                            <!-- Dimension Score Grid -->
                            <div class="grid md:grid-cols-3 gap-4 mb-6">
                                {% for dimension, score in result.pdqi_scores.items() %}
                                {% if dimension != 'summary' and dimension != 'scoring_rationale' and dimension != 'dimension_explanations' %}
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="font-medium capitalize">{{ dimension.replace('_', ' ') }}</span>
                                        <span class="text-lg font-bold 
                                            {% if score|to_number >= 4 %}text-green-600
                                            {% elif score|to_number >= 3 %}text-blue-600
                                            {% elif score|to_number >= 2 %}text-yellow-600
                                            {% else %}text-red-600{% endif %}">
                                            {{ score }}/5
                                        </span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-blue-600 h-2 rounded-full score-bar-{{ ((score|to_number / 5) * 100)|int }}"></div>
                                    </div>
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                            
                            <!-- Detailed Dimension Explanations -->
                            {% if result.pdqi_scores.dimension_explanations and result.pdqi_scores.dimension_explanations|length > 0 %}
                            <div class="space-y-3">
                                <h4 class="text-lg font-semibold text-blue-700 mb-3">Detailed Dimension Analysis</h4>
                                {% for explanation in result.pdqi_scores.dimension_explanations %}
                                <div class="dimension-card bg-white border border-gray-100 rounded-lg">
                                    <div class="dimension-header p-3 cursor-pointer" data-target="dimension-{{ loop.index0 }}">
                                        <div class="flex justify-between items-center">
                                            <div class="flex items-center space-x-3">
                                                <h5 class="font-semibold capitalize text-gray-800">
                                                    {{ explanation.dimension.replace('_', ' ') }}
                                                </h5>
                                                <span class="font-bold px-2 py-1 rounded-full text-sm
                                                    {% if explanation.score >= 4 %}bg-green-100 text-green-800
                                                    {% elif explanation.score >= 3 %}bg-blue-100 text-blue-800
                                                    {% elif explanation.score >= 2 %}bg-yellow-100 text-yellow-800
                                                    {% else %}bg-red-100 text-red-800{% endif %}">
                                                    {{ explanation.score }}/5
                                                </span>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <div class="text-xs text-gray-500 max-w-sm truncate">
                                                    {{ explanation.narrative|truncate(50) }}
                                                </div>
                                                <svg class="dimension-icon w-4 h-4 text-gray-400 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                </svg>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div id="dimension-{{ loop.index0 }}" class="dimension-content hidden border-t border-gray-100">
                                        <div class="p-3 space-y-3">
                                            <div class="text-gray-700 text-sm leading-relaxed">
                                                {{ explanation.narrative }}
                                            </div>
                                            
                                            {% if explanation.evidence_excerpts and explanation.evidence_excerpts|length > 0 %}
                                            <div class="bg-blue-50 rounded p-2">
                                                <h6 class="text-xs font-medium text-blue-600 mb-1">Evidence:</h6>
                                                {% for excerpt in explanation.evidence_excerpts %}
                                                <div class="text-xs italic text-blue-800 mb-1">"{{ excerpt }}"</div>
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                            
                                            {% if explanation.improvement_suggestions and explanation.improvement_suggestions|length > 0 %}
                                            <div class="bg-green-50 rounded p-2">
                                                <h6 class="text-xs font-medium text-green-600 mb-1">Suggestions:</h6>
                                                <ul class="text-xs text-green-800 space-y-1">
                                                    {% for suggestion in explanation.improvement_suggestions %}
                                                    <li>• {{ suggestion }}</li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Factuality Analysis - Progressive Disclosure -->
            <div class="mb-6">
                <div class="narrative-card bg-white border border-gray-200 rounded-lg shadow-sm">
                    <div class="card-header p-4 cursor-pointer" data-target="factuality-analysis">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center space-x-4">
                                <h3 class="text-xl font-semibold">🔍 Factuality Analysis</h3>
                                <div class="flex space-x-3 text-sm">
                                    <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded">
                                        Score: {{ result.factuality_analysis.consistency_score }}
                                    </span>
                                    <span class="bg-gray-100 text-gray-800 px-2 py-1 rounded">
                                        {{ result.factuality_analysis.claims_checked }} Claims
                                    </span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="summary-preview text-sm text-gray-600">
                                    Click to view claim-level analysis
                                </div>
                                <svg class="expand-icon w-5 h-5 text-gray-400 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div id="factuality-analysis" class="card-content hidden border-t border-gray-100">
                        <div class="p-4 space-y-4">
                            {% if result.factuality_analysis.consistency_narrative %}
                            <div class="bg-purple-50 rounded-lg p-3">
                                <h5 class="font-medium text-purple-700 mb-2">Overall Consistency Assessment</h5>
                                <p class="text-purple-800 text-sm">{{ result.factuality_analysis.consistency_narrative }}</p>
                            </div>
                            {% endif %}
                            
                            {% if result.factuality_analysis.claims and result.factuality_analysis.claims|length > 0 %}
                            <div>
                                <h5 class="font-medium text-orange-600 mb-3">Individual Claims Analysis</h5>
                                <div class="space-y-2">
                                    {% for claim in result.factuality_analysis.claims %}
                                    <div class="bg-orange-50 rounded-lg p-3 border-l-4 border-orange-400">
                                        <div class="flex justify-between items-start mb-2">
                                            <span class="font-medium text-orange-800 text-sm">{{ claim.claim }}</span>
                                            <span class="px-2 py-1 rounded text-xs font-semibold
                                                {% if claim.support == 'Supported' %}bg-green-100 text-green-800
                                                {% elif claim.support == 'Not Supported' %}bg-red-100 text-red-800
                                                {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                                {{ claim.support }}
                                            </span>
                                        </div>
                                        <p class="text-orange-700 text-xs">{{ claim.explanation }}</p>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}

                            <!-- O3-Detected Hallucinations (NEW) -->
                            {% if result.factuality_analysis.hallucinations and result.factuality_analysis.hallucinations|length > 0 %}
                            <div>
                                <h5 class="font-medium text-yellow-600 mb-3">⚠️ Unsubstantiated Claims Detected</h5>
                                <div class="space-y-3">
                                    {% for hallucination in result.factuality_analysis.hallucinations %}
                                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-lg">
                                        <div class="flex justify-between items-start mb-3">
                                            <div class="flex items-center space-x-2">
                                                <span class="text-sm font-medium text-yellow-800">Unsubstantiated Claim</span>
                                                <span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-xs">
                                                    {{ hallucination.medical_category|replace('_', ' ')|title }}
                                                </span>
                                                <span class="px-2 py-1 rounded text-xs font-medium
                                                    {% if hallucination.risk_level == 'high' %}bg-red-100 text-red-700
                                                    {% elif hallucination.risk_level == 'medium' %}bg-yellow-100 text-yellow-700
                                                    {% else %}bg-green-100 text-green-700{% endif %}">
                                                    {{ hallucination.risk_level|title }} Risk
                                                </span>
                                            </div>
                                            <div class="flex items-center space-x-1">
                                                <span class="text-xs text-yellow-600">Confidence:</span>
                                                <span class="text-sm font-semibold text-yellow-800">{{ (hallucination.confidence * 100)|round|int }}%</span>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <div class="text-sm font-medium text-yellow-800 mb-1">Claim:</div>
                                            <div class="text-sm text-yellow-700 bg-yellow-100 rounded p-2">
                                                "{{ hallucination.claim }}"
                                            </div>
                                        </div>
                                        {% if hallucination.recommendation %}
                                        <div class="text-xs text-yellow-600 italic">
                                            <strong>Recommendation:</strong> {{ hallucination.recommendation }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                                <div class="mt-4 p-3 bg-blue-50 border-l-4 border-blue-400 rounded">
                                    <p class="text-xs text-blue-800">
                                        <strong>Note:</strong> These unsubstantiated claims were detected by O3-mini during factuality analysis. 
                                        They represent statements that appear factual but lack supporting evidence in the encounter transcript.
                                    </p>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hallucination Detection - Progressive Disclosure -->
            {% if result.discrepancy_analysis and result.discrepancy_analysis.hallucinations and result.discrepancy_analysis.hallucinations.count > 0 %}
            <div class="mb-6">
                <div class="narrative-card bg-white border border-gray-200 rounded-lg shadow-sm">
                    <div class="card-header p-4 cursor-pointer" data-target="hallucination-analysis">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center space-x-4">
                                <h3 class="text-xl font-semibold text-yellow-700">⚠️ Hallucination Detection</h3>
                                <div class="flex items-center space-x-2">
                                    <span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm font-medium">
                                        {{ result.discrepancy_analysis.hallucinations.count }} Unsubstantiated Claims
                                    </span>
                                    {% if result.discrepancy_analysis.hallucinations.results %}
                                    {% set high_risk_hallucinations = result.discrepancy_analysis.hallucinations.results | selectattr('risk_level', 'equalto', 'high') | list %}
                                    {% if high_risk_hallucinations|length > 0 %}
                                    <span class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-sm font-medium">
                                        {{ high_risk_hallucinations|length }} High Risk
                                    </span>
                                    {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="summary-preview text-sm text-gray-600">
                                    AI-powered claim verification analysis
                                </div>
                                <svg class="expand-icon w-5 h-5 text-gray-400 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div id="hallucination-analysis" class="card-content hidden border-t border-gray-100">
                        <div class="p-6">
                            <div class="mb-4">
                                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-lg mb-4">
                                    <p class="text-sm text-yellow-800">
                                        <strong>Hallucination Detection:</strong> This analysis identifies claims in the clinical note that cannot be substantiated by the provided transcript or evidence. 
                                        These may represent potential documentation errors, unsupported clinical assertions, or information that requires verification.
                                    </p>
                                </div>
                            </div>

                            <!-- Hallucinations List -->
                            <div class="space-y-4">
                                {% for hallucination in result.discrepancy_analysis.hallucinations.results %}
                                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-lg">
                                    <div class="flex justify-between items-start mb-3">
                                        <div class="flex items-center space-x-2">
                                            <span class="text-sm font-medium text-yellow-800">Unsubstantiated Claim</span>
                                            <span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-xs">
                                                {{ hallucination.medical_category|replace('_', ' ')|title }}
                                            </span>
                                            <span class="px-2 py-1 rounded text-xs font-medium
                                                {% if hallucination.risk_level == 'high' %}bg-red-100 text-red-700
                                                {% elif hallucination.risk_level == 'medium' %}bg-yellow-100 text-yellow-700
                                                {% else %}bg-green-100 text-green-700{% endif %}">
                                                {{ hallucination.risk_level|title }} Risk
                                            </span>
                                        </div>
                                        <div class="flex items-center space-x-1">
                                            <span class="text-xs text-yellow-600">Confidence:</span>
                                            <span class="text-sm font-semibold text-yellow-800">{{ (hallucination.confidence * 100)|round|int }}%</span>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <div class="text-sm font-medium text-yellow-800 mb-1">Claim:</div>
                                        <div class="text-sm text-yellow-700 bg-yellow-100 rounded p-2">
                                            "{{ hallucination.claim }}"
                                        </div>
                                    </div>
                                    {% if hallucination.recommendation %}
                                    <div class="mb-2">
                                        <div class="text-sm font-medium text-yellow-800 mb-1">Recommendation:</div>
                                        <div class="text-xs text-yellow-600 italic">
                                            {{ hallucination.recommendation }}
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if hallucination.context_similarity is defined %}
                                    <div class="text-xs text-yellow-600 mt-2">
                                        Context similarity: {{ (hallucination.context_similarity * 100)|round|int }}%
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>

                            <!-- Performance Info -->
                            <div class="mt-6 pt-4 border-t border-gray-200 text-xs text-gray-500">
                                Hallucination analysis completed in {{ result.discrepancy_analysis.hallucinations.processing_time_ms }}ms using embedding-based verification
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Heuristic Analysis - Progressive Disclosure -->
            <div class="mb-6">
                <div class="narrative-card bg-white border border-gray-200 rounded-lg shadow-sm">
                    <div class="card-header p-4 cursor-pointer" data-target="heuristic-analysis">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center space-x-4">
                                <h3 class="text-xl font-semibold">📊 Document Quality Metrics</h3>
                                <span class="text-lg font-bold bg-green-100 text-green-800 px-3 py-1 rounded-full">
                                    {{ result.heuristic_analysis.composite_score }}/5.0
                                </span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="summary-preview text-sm text-gray-600">
                                    Length • Structure • Redundancy analysis
                                </div>
                                <svg class="expand-icon w-5 h-5 text-gray-400 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div id="heuristic-analysis" class="card-content hidden border-t border-gray-100">
                        <div class="p-4">
                            <div class="grid md:grid-cols-2 gap-6">
                                <div class="space-y-4">
                                    <div class="bg-gray-50 rounded-lg p-4">
                                        <h5 class="font-medium mb-3">Quality Scores</h5>
                                        <div class="space-y-3">
                                            <div class="flex justify-between items-center">
                                                <span>Length:</span>
                                                <div class="flex items-center space-x-2">
                                                    <div class="w-16 bg-gray-200 rounded-full h-2">
                                                        <div class="bg-blue-600 h-2 rounded-full score-bar-{{ ((result.heuristic_analysis.length_score|to_number / 5) * 100)|int }}"></div>
                                                    </div>
                                                    <span class="font-semibold text-sm">{{ result.heuristic_analysis.length_score }}/5</span>
                                                </div>
                                            </div>
                                            <div class="flex justify-between items-center">
                                                <span>Structure:</span>
                                                <div class="flex items-center space-x-2">
                                                    <div class="w-16 bg-gray-200 rounded-full h-2">
                                                        <div class="bg-blue-600 h-2 rounded-full score-bar-{{ ((result.heuristic_analysis.structure_score|to_number / 5) * 100)|int }}"></div>
                                                    </div>
                                                    <span class="font-semibold text-sm">{{ result.heuristic_analysis.structure_score }}/5</span>
                                                </div>
                                            </div>
                                            <div class="flex justify-between items-center">
                                                <span>Redundancy:</span>
                                                <div class="flex items-center space-x-2">
                                                    <div class="w-16 bg-gray-200 rounded-full h-2">
                                                        <div class="bg-blue-600 h-2 rounded-full score-bar-{{ ((result.heuristic_analysis.redundancy_score|to_number / 5) * 100)|int }}"></div>
                                                    </div>
                                                    <span class="font-semibold text-sm">{{ result.heuristic_analysis.redundancy_score }}/5</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Quality Score Explanations -->
                                        <div class="mt-4 pt-4 border-t border-gray-200 space-y-3 text-sm text-gray-600">
                                            <div>
                                                <strong class="text-gray-700">Length:</strong> Evaluates note appropriateness based on character count. Optimal range is 4,600-5,000 characters, reflecting current EHR standards for comprehensive yet concise clinical documentation.
                                            </div>
                                            <div>
                                                <strong class="text-gray-700">Structure:</strong> Assesses logical organization, section headers, and use of lists or bullet points. Well-structured notes improve readability and clinical utility.
                                            </div>
                                            <div>
                                                <strong class="text-gray-700">Redundancy:</strong> Identifies repeated phrases and unnecessary duplication. Lower redundancy indicates more efficient and focused documentation.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="space-y-4">
                                    <div class="bg-gray-50 rounded-lg p-4">
                                        <h5 class="font-medium mb-3">Document Stats</h5>
                                        <div class="space-y-2 text-sm">
                                            <div class="flex justify-between">
                                                <span>Words:</span>
                                                <span class="font-semibold">{{ result.heuristic_analysis.word_count }}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>Characters:</span>
                                                <span class="font-semibold">{{ result.heuristic_analysis.character_count }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Week 2: Embedding-Based Discrepancy Analysis -->
            {% if result.discrepancy_analysis and result.discrepancy_analysis.has_transcript %}
            <div class="mb-6">
                <div class="narrative-card bg-white border border-gray-200 rounded-lg shadow-sm">
                    <div class="card-header p-4 cursor-pointer" data-target="discrepancy-analysis">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center space-x-4">
                                <h3 class="text-xl font-semibold text-indigo-700">🔬 Embedding-Based Discrepancy Analysis</h3>
                                <div class="flex items-center space-x-2">
                                    <div class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-sm font-medium">
                                        AI-Enhanced Layer 2 & 3 Detection
                                    </div>
                                    {% if result.discrepancy_analysis.summary.high_risk_count > 0 %}
                                    <div class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-sm font-medium">
                                        ⚠️ {{ result.discrepancy_analysis.summary.high_risk_count }} High-Risk Issues
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="summary-preview text-sm text-gray-600">
                                    {{ result.discrepancy_analysis.summary.total_issues }} Issues Found
                                </div>
                                <svg class="expand-icon w-5 h-5 text-gray-400 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div id="discrepancy-analysis" class="card-content hidden border-t border-gray-100">
                        <div class="p-6">
                            <!-- Summary Dashboard -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <!-- Total Issues Card -->
                                <div class="bg-indigo-50 border-l-4 border-indigo-400 p-4 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm font-medium text-indigo-800">Total Issues</p>
                                            <p class="text-2xl font-bold text-indigo-900">{{ result.discrepancy_analysis.summary.total_issues }}</p>
                                        </div>
                                        <div class="text-indigo-600">
                                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Contradictions Card -->
                                <div class="bg-red-50 border-l-4 border-red-400 p-4 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm font-medium text-red-800">Contradictions</p>
                                            <p class="text-2xl font-bold text-red-900">{{ result.discrepancy_analysis.contradictions.count }}</p>
                                        </div>
                                        <div class="text-red-600">
                                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Hallucinations Card -->
                                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm font-medium text-yellow-800">Hallucinations</p>
                                            <p class="text-2xl font-bold text-yellow-900">{{ result.discrepancy_analysis.hallucinations.count }}</p>
                                        </div>
                                        <div class="text-yellow-600">
                                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Medical Category Distribution -->
                            {% if result.discrepancy_analysis.summary.medical_categories %}
                            <div class="mb-6">
                                <h4 class="font-semibold text-gray-800 mb-3">Medical Category Distribution</h4>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    {% for category, count in result.discrepancy_analysis.summary.medical_categories.items() %}
                                    <div class="bg-gray-50 border rounded-lg p-3 text-center">
                                        <div class="font-semibold text-gray-900">{{ count }}</div>
                                        <div class="text-sm text-gray-600 capitalize">{{ category|replace('_', ' ') }}</div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}

                            <!-- Contradictions Section -->
                            {% if result.discrepancy_analysis.contradictions.count > 0 %}
                            <div class="mb-6">
                                <h4 class="font-semibold text-red-800 mb-3">🚫 Contradictions Found</h4>
                                <div class="space-y-3">
                                    {% for contradiction in result.discrepancy_analysis.contradictions.results %}
                                    <div class="bg-red-50 border-l-4 border-red-400 p-4 rounded-lg">
                                        <div class="flex justify-between items-start mb-2">
                                            <div class="flex items-center space-x-2">
                                                <span class="text-sm font-medium text-red-800 capitalize">{{ contradiction.contradiction_type|replace('_', ' ') }} Contradiction</span>
                                                <span class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs">{{ contradiction.medical_category|replace('_', ' ')|title }}</span>
                                            </div>
                                            <div class="flex items-center space-x-1">
                                                <span class="text-xs text-red-600">Severity:</span>
                                                <span class="text-sm font-semibold text-red-800">{{ (contradiction.severity * 100)|round|int }}%</span>
                                            </div>
                                        </div>
                                        <div class="text-sm text-red-700 mb-2">
                                            <strong>Note:</strong> {{ contradiction.note_statement }}
                                        </div>
                                        <div class="text-sm text-red-700 mb-2">
                                            <strong>Transcript:</strong> {{ contradiction.transcript_statement }}
                                        </div>
                                        {% if contradiction.explanation %}
                                        <div class="text-xs text-red-600 italic">
                                            {{ contradiction.explanation }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}

                            <!-- Hallucinations Section -->
                            {% if result.discrepancy_analysis.hallucinations.count > 0 %}
                            <div class="mb-4">
                                <h4 class="font-semibold text-yellow-800 mb-3">⚠️ Potential Hallucinations</h4>
                                <div class="space-y-3">
                                    {% for hallucination in result.discrepancy_analysis.hallucinations.results %}
                                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-lg">
                                        <div class="flex justify-between items-start mb-2">
                                            <div class="flex items-center space-x-2">
                                                <span class="text-sm font-medium text-yellow-800">Unsubstantiated Claim</span>
                                                <span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-xs">{{ hallucination.medical_category|replace('_', ' ')|title }}</span>
                                                <span class="px-2 py-1 rounded text-xs font-medium
                                                    {% if hallucination.risk_level == 'high' %}bg-red-100 text-red-700
                                                    {% elif hallucination.risk_level == 'medium' %}bg-yellow-100 text-yellow-700
                                                    {% else %}bg-green-100 text-green-700{% endif %}">
                                                    {{ hallucination.risk_level|title }} Risk
                                                </span>
                                            </div>
                                            <div class="flex items-center space-x-1">
                                                <span class="text-xs text-yellow-600">Confidence:</span>
                                                <span class="text-sm font-semibold text-yellow-800">{{ (hallucination.confidence * 100)|round|int }}%</span>
                                            </div>
                                        </div>
                                        <div class="text-sm text-yellow-700 mb-2">
                                            <strong>Claim:</strong> {{ hallucination.claim }}
                                        </div>
                                        {% if hallucination.recommendation %}
                                        <div class="text-xs text-yellow-600 italic">
                                            {{ hallucination.recommendation }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}

                            <!-- Processing Performance -->
                            <div class="mt-4 pt-4 border-t border-gray-200 text-xs text-gray-500">
                                Analysis completed in {{ result.discrepancy_analysis.contradictions.processing_time_ms + result.discrepancy_analysis.hallucinations.processing_time_ms }}ms
                                (Contradictions: {{ result.discrepancy_analysis.contradictions.processing_time_ms }}ms, Hallucinations: {{ result.discrepancy_analysis.hallucinations.processing_time_ms }}ms)
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Scoring Methodology -->
            <div class="bg-blue-50 rounded-lg p-4">
                <h4 class="font-medium mb-2">Hybrid Scoring Weights</h4>
                <div class="grid grid-cols-3 gap-4 text-sm">
                    <div class="text-center">
                        <div class="font-semibold">PDQI-9</div>
                        <div>{{ (result.weights_used.pdqi_weight * 100)|int }}%</div>
                    </div>
                    <div class="text-center">
                        <div class="font-semibold">Heuristics</div>
                        <div>{{ (result.weights_used.heuristic_weight * 100)|int }}%</div>
                    </div>
                    <div class="text-center">
                        <div class="font-semibold">Factuality</div>
                        <div>{{ (result.weights_used.factuality_weight * 100)|int }}%</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Reasoning Process Tab -->
    {% if (result.reasoning_analysis_log and result.reasoning_analysis_log|length > 0) or (result.chain_of_thought and result.chain_of_thought|length > 0) %}
    <div id="reasoning-content" class="tab-content hidden">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-bold">🧠 AI Reasoning Process Analysis Log</h2>
                    <p class="text-gray-600 text-sm mt-1">Comprehensive step-by-step analysis and decision-making process</p>
                </div>
                <div class="flex space-x-2">
                    <button onclick="copyToClipboard()" class="bg-gray-100 text-gray-700 px-3 py-2 rounded text-sm hover:bg-gray-200 transition-colors">
                        📋 Copy Text
                    </button>
                    <button onclick="downloadReasoning()" class="bg-blue-100 text-blue-700 px-3 py-2 rounded text-sm hover:bg-blue-200 transition-colors">
                        💾 Download
                    </button>
                </div>
            </div>
            
            <!-- Primary Reasoning Analysis Log -->
            {% if result.reasoning_analysis_log and result.reasoning_analysis_log|length > 0 %}
            <div class="reasoning-container bg-gray-50 rounded-lg p-4 border mb-6">
                <div class="bg-white rounded border p-4 max-h-96 overflow-y-auto">
                    <pre id="reasoning-text" class="whitespace-pre-wrap text-sm font-mono leading-relaxed text-gray-800">{{ result.reasoning_analysis_log }}</pre>
                </div>
            </div>
            {% endif %}
            
            <!-- Fallback to Chain of Thought if Analysis Log not available -->
            {% if not result.reasoning_analysis_log and result.chain_of_thought and result.chain_of_thought|length > 0 %}
            <div class="reasoning-container bg-gray-50 rounded-lg p-4 border mb-6">
                <div class="bg-white rounded border p-4 max-h-96 overflow-y-auto">
                    <pre id="reasoning-text" class="whitespace-pre-wrap text-sm font-mono leading-relaxed text-gray-800">{{ result.chain_of_thought }}</pre>
                </div>
            </div>
            {% endif %}
            
            <div class="mt-4 text-xs text-gray-500">
                <p><strong>Note:</strong> This comprehensive analysis log shows the internal reasoning process of the O3 AI model during assessment. 
                It includes detailed component analysis, scoring methodology, claim-level factuality assessment, and the mathematical integration process that led to the final hybrid score and grade.</p>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tab switching functionality
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target');
            
            // Update button states
            tabButtons.forEach(btn => {
                btn.classList.remove('active', 'bg-white', 'text-blue-600', 'shadow-sm');
                btn.classList.add('text-gray-600', 'hover:text-gray-900');
            });
            
            this.classList.add('active', 'bg-white', 'text-blue-600', 'shadow-sm');
            this.classList.remove('text-gray-600', 'hover:text-gray-900');
            
            // Update content visibility
            tabContents.forEach(content => {
                content.classList.add('hidden');
            });
            
            document.getElementById(targetId).classList.remove('hidden');
        });
    });
    
    // Main narrative cards
    const narrativeCards = document.querySelectorAll('.narrative-card');
    narrativeCards.forEach(initializeCard);
    
    // Dimension cards (nested)
    const dimensionCards = document.querySelectorAll('.dimension-card');
    dimensionCards.forEach(initializeDimensionCard);
    
    function initializeCard(card) {
        const header = card.querySelector('.card-header');
        const content = card.querySelector('.card-content');
        const expandIcon = card.querySelector('.expand-icon');
        
        header.addEventListener('click', function() {
            toggleCard(content, expandIcon, header);
        });
        
        setupAccessibility(header);
    }
    
    function initializeDimensionCard(card) {
        const header = card.querySelector('.dimension-header');
        const content = card.querySelector('.dimension-content');
        const expandIcon = card.querySelector('.dimension-icon');
        
        header.addEventListener('click', function(e) {
            e.stopPropagation();
            toggleCard(content, expandIcon, header);
        });
        
        setupAccessibility(header);
    }
    
    function toggleCard(content, expandIcon, header) {
        const isExpanded = !content.classList.contains('hidden');
        content.classList.toggle('hidden');
        expandIcon.style.transform = isExpanded ? 'rotate(0deg)' : 'rotate(180deg)';
        header.setAttribute('aria-expanded', !isExpanded);
    }
    
    function setupAccessibility(header) {
        header.setAttribute('role', 'button');
        header.setAttribute('aria-expanded', 'false');
        header.setAttribute('tabindex', '0');
        
        header.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                header.click();
            }
        });
    }
});

// Utility functions for reasoning tab
function copyToClipboard() {
    const reasoningText = document.getElementById('reasoning-text').textContent;
    navigator.clipboard.writeText(reasoningText).then(function() {
        // Visual feedback
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = '✅ Copied!';
        button.classList.add('bg-green-100', 'text-green-700');
        button.classList.remove('bg-gray-100', 'text-gray-700');
        
        setTimeout(() => {
            button.textContent = originalText;
            button.classList.remove('bg-green-100', 'text-green-700');
            button.classList.add('bg-gray-100', 'text-gray-700');
        }, 2000);
    });
}

function downloadReasoning() {
    const reasoningText = document.getElementById('reasoning-text').textContent;
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const filename = `ai-reasoning-analysis-log-${timestamp}.txt`;
    
    // Create enhanced content with header
    const enhancedContent = `Clinical Note Quality Assessment - AI Reasoning Analysis Log
Generated: ${new Date().toLocaleString()}
================================================================

${reasoningText}

================================================================
Generated by Clinical Note Quality Assessment System using O3 reasoning models`;
    
    const blob = new Blob([enhancedContent], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    // Visual feedback
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = '✅ Downloaded!';
    button.classList.add('bg-green-100', 'text-green-700');
    button.classList.remove('bg-blue-100', 'text-blue-700');
    
    setTimeout(() => {
        button.textContent = originalText;
        button.classList.remove('bg-green-100', 'text-green-700');
        button.classList.add('bg-blue-100', 'text-blue-700');
    }, 2000);
}
</script>

<style>
.score-bar-0 { width: 0%; }
.score-bar-20 { width: 20%; }
.score-bar-40 { width: 40%; }
.score-bar-60 { width: 60%; }
.score-bar-80 { width: 80%; }
.score-bar-100 { width: 100%; }

.narrative-card, .dimension-card {
    transition: all 0.2s ease-in-out;
}

.narrative-card:hover, .dimension-card:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.card-header:hover, .dimension-header:hover {
    background-color: #f8fafc;
}

.expand-icon, .dimension-icon {
    transition: transform 0.2s ease-in-out;
}

.card-content, .dimension-content {
    animation: slideDown 0.3s ease-out;
}

.tab-content {
    animation: fadeIn 0.3s ease-out;
}

.reasoning-container {
    position: relative;
}

.reasoning-container pre {
    line-height: 1.5;
    word-wrap: break-word;
    white-space: pre-wrap;
}

@keyframes slideDown {
    from {
        opacity: 0;
        max-height: 0;
    }
    to {
        opacity: 1;
        max-height: 1000px;
    }
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
</style>
{% endblock %}